name: Build FFmpeg (OpenWrt 24.10.x PI4 Nonfree Static)

on:
  push:
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  workflow_dispatch:

env:
  OPENWRT_VERSION: "24.10.5"
  OPENWRT_TARGET: "bcm27xx"
  OPENWRT_SUBTARGET: "bcm2711"
  ARCH_TRIPLET: "aarch64-openwrt-linux-musl"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------------
    # Install host deps
    # ------------------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential autoconf automake libtool \
          pkg-config yasm nasm meson ninja-build \
          cmake git wget curl python3 zstd

    # ------------------------------------------------------------
    # Download OpenWrt SDK (auto detect)
    # ------------------------------------------------------------
    - name: Download OpenWrt SDK
      run: |
        set -e

        BASE_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/${OPENWRT_TARGET}/${OPENWRT_SUBTARGET}/"

        SDK_FILE=$(curl -s "$BASE_URL" | \
          grep -oP 'openwrt-sdk-[^"]+musl\.Linux-x86_64\.tar\.(zst|xz)' | \
          head -n1)

        if [ -z "$SDK_FILE" ]; then
          echo "SDK not found"
          exit 1
        fi

        echo "Downloading $SDK_FILE"
        wget "${BASE_URL}${SDK_FILE}"

        if [[ "$SDK_FILE" == *.zst ]]; then
          tar -I zstd -xf "$SDK_FILE"
        else
          tar -xf "$SDK_FILE"
        fi

        SDK_DIR=$(find . -maxdepth 1 -type d -name 'openwrt-sdk-*' | head -n1)
        echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # Setup OpenWrt toolchain environment
    # ------------------------------------------------------------
    - name: Setup toolchain
      run: |
        set -e

        STAGING_DIR="$SDK_DIR/staging_dir"

        TOOLCHAIN_DIR=$(ls -d "$STAGING_DIR"/toolchain-* | head -n1)
        TARGET_DIR=$(ls -d "$STAGING_DIR"/target-* | head -n1)

        echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR"
        echo "TARGET_DIR=$TARGET_DIR"

        echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR" >> $GITHUB_ENV
        echo "TARGET_DIR=$TARGET_DIR" >> $GITHUB_ENV

        echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

    # ------------------------------------------------------------
    # Build x264 (static)
    # ------------------------------------------------------------
    - name: Build x264
      run: |
        set -e

        git clone --depth=1 https://code.videolan.org/videolan/x264.git
        cd x264

        export CC=${ARCH_TRIPLET}-gcc
        export CFLAGS="--sysroot=$TARGET_DIR"
        export LDFLAGS="--sysroot=$TARGET_DIR"

        ./configure \
          --host=${ARCH_TRIPLET} \
          --cross-prefix=${ARCH_TRIPLET}- \
          --enable-static \
          --disable-opencl \
          --disable-cli \
          --prefix=$PWD/build

        make -j$(nproc)
        make install

        echo "X264_PATH=$PWD/build" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # Build fdk-aac (static nonfree)
    # ------------------------------------------------------------
    - name: Build fdk-aac
      run: |
        set -e

        git clone https://github.com/mstorsjo/fdk-aac.git
        cd fdk-aac

        export CC=${ARCH_TRIPLET}-gcc
        export CFLAGS="--sysroot=$TARGET_DIR"
        export LDFLAGS="--sysroot=$TARGET_DIR"

        autoreconf -fiv

        ./configure \
          --host=${ARCH_TRIPLET} \
          --disable-shared \
          --enable-static \
          --prefix=$PWD/build

        make -j$(nproc)
        make install

        echo "FDK_PATH=$PWD/build" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # Build FFmpeg (fully static)
    # ------------------------------------------------------------
    - name: Build FFmpeg
      run: |
        set -e

        git clone --depth=1 https://git.ffmpeg.org/ffmpeg.git FFmpeg
        cd FFmpeg

        export CC=${ARCH_TRIPLET}-gcc
        export CFLAGS="--sysroot=$TARGET_DIR"
        export LDFLAGS="--sysroot=$TARGET_DIR -static"

        ./configure \
          --prefix=$PWD/build \
          --arch=aarch64 \
          --target-os=linux \
          --cross-prefix=${ARCH_TRIPLET}- \
          --enable-cross-compile \
          --enable-gpl \
          --enable-nonfree \
          --enable-static \
          --disable-shared \
          --disable-debug \
          --disable-doc \
          --disable-ffplay \
          --enable-libx264 \
          --enable-libfdk-aac \
          --extra-cflags="--sysroot=$TARGET_DIR -I${X264_PATH}/include -I${FDK_PATH}/include" \
          --extra-ldflags="--sysroot=$TARGET_DIR -static -L${X264_PATH}/lib -L${FDK_PATH}/lib"

        make -j$(nproc)
        make install

    # ------------------------------------------------------------
    # Verify static binary
    # ------------------------------------------------------------
    - name: Verify
      run: |
        file FFmpeg/build/bin/ffmpeg
        ldd FFmpeg/build/bin/ffmpeg || echo "Static binary confirmed"

    # ------------------------------------------------------------
    # Upload artifact
    # ------------------------------------------------------------
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-openwrt-24.10.x-pi4-nonfree-static
        path: FFmpeg/build/bin/ffmpeg
