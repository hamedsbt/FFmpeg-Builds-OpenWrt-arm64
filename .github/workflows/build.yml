name: Build FFmpeg (OpenWrt 24.10.2 PI4 Nonfree Static)

on:
  push:
    paths-ignore:
      - '**.md'
      - 'LICENSE'
  workflow_dispatch:
  schedule:
    - cron: '23 4 * * *'   # randomized for fork safety

env:
  OPENWRT_VERSION: "24.10.2"
  OPENWRT_TARGET: "bcm27xx"
  OPENWRT_SUBTARGET: "bcm2711"
  ARCH_TRIPLET: "aarch64-openwrt-linux-musl"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    # ------------------------------------------------------------
    # Cleanup
    # ------------------------------------------------------------
    - name: Free Disk Space
      run: |
        df -h
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet /opt/ghc || true
        df -h

    # ------------------------------------------------------------
    # Checkout
    # ------------------------------------------------------------
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    # ------------------------------------------------------------
    # Install host build deps
    # ------------------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          autoconf automake libtool \
          pkg-config \
          yasm nasm \
          meson ninja-build \
          cmake git wget curl \
          python3

    # ------------------------------------------------------------
    # Download OpenWrt SDK
    # ------------------------------------------------------------
    - name: Download OpenWrt SDK
      run: |
        SDK_URL="https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/${OPENWRT_TARGET}/${OPENWRT_SUBTARGET}/openwrt-sdk-${OPENWRT_VERSION}-${OPENWRT_TARGET}-${OPENWRT_SUBTARGET}_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
        echo "Dynamic sdk url: $SDK_URL"
        SDK_URL="https://downloads.openwrt.org/releases/24.10.5/targets/bcm27xx/bcm2711/openwrt-sdk-24.10.5-bcm27xx-bcm2711_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
        wget $SDK_URL -O sdk.tar.zst
        tar xf sdk.tar.zst
        echo "SDK_DIR=$(find . -maxdepth 1 -type d -name 'openwrt-sdk-*')" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # Setup OpenWrt toolchain env
    # ------------------------------------------------------------
    - name: Setup toolchain
      run: |
        TOOLCHAIN_DIR="$SDK_DIR/staging_dir/toolchain-*"
        echo "TOOLCHAIN_DIR=$(echo $TOOLCHAIN_DIR)" >> $GITHUB_ENV
        echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

    # ------------------------------------------------------------
    # Build dependencies (static)
    # ------------------------------------------------------------

    - name: Build fdk-aac (nonfree)
      run: |
        git clone https://github.com/mstorsjo/fdk-aac.git
        cd fdk-aac
        autoreconf -fiv
        CC=${ARCH_TRIPLET}-gcc \
        ./configure \
          --host=${ARCH_TRIPLET} \
          --disable-shared \
          --enable-static \
          --prefix=$PWD/build
        make -j$(nproc)
        make install
        echo "FDK_PATH=$PWD/build" >> $GITHUB_ENV

    - name: Build x264
      run: |
        git clone https://code.videolan.org/videolan/x264.git
        cd x264
        CC=${ARCH_TRIPLET}-gcc \
        ./configure \
          --host=${ARCH_TRIPLET} \
          --enable-static \
          --disable-opencl \
          --prefix=$PWD/build
        make -j$(nproc)
        make install
        echo "X264_PATH=$PWD/build" >> $GITHUB_ENV

    # ------------------------------------------------------------
    # Configure & Build FFmpeg
    # ------------------------------------------------------------
    - name: Configure FFmpeg
      run: |
        cd FFmpeg
        export PKG_CONFIG=false

        ./configure \
          --prefix=$PWD/build \
          --cross-prefix=${ARCH_TRIPLET}- \
          --arch=aarch64 \
          --target-os=linux \
          --enable-cross-compile \
          --enable-gpl \
          --enable-nonfree \
          --enable-static \
          --disable-shared \
          --disable-debug \
          --enable-libx264 \
          --enable-libfdk-aac \
          --extra-cflags="-I${X264_PATH}/include -I${FDK_PATH}/include" \
          --extra-ldflags="-L${X264_PATH}/lib -L${FDK_PATH}/lib"

    - name: Build FFmpeg
      run: |
        cd FFmpeg
        make -j$(nproc)
        make install

    # ------------------------------------------------------------
    # Verify binary
    # ------------------------------------------------------------
    - name: Verify
      run: |
        file FFmpeg/build/bin/ffmpeg

    # ------------------------------------------------------------
    # Upload artifact
    # ------------------------------------------------------------
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-openwrt-24.10.2-pi4-nonfree-static
        path: FFmpeg/build/bin/ffmpeg
